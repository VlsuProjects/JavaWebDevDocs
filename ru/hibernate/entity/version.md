# Аннотация @Version

Аннотация `@Version` используется для версионирования сущности. Это означает, что каждый раз, когда сущность обновляется, значение версии увеличивается. Это позволяет JPA контролировать конфликты параллельных изменений.

Более того, аннотация `@Version` позволяет избежать потери данных при параллельных изменениях сущностей разными пользователями. Если два пользователя пытаются обновить одну и ту же сущность одновременно, Hibernate сравнит значения версий и выберет одно из изменений, а другое отклонит.

В идеале, конечно, лучше избегать параллельных изменений, но если это неизбежно, версионирование сущностей поможет избежать потери данных.

Логика по которой Hibernate выбирает одно из изменений, а другое отклоняет, зависит от стратегии версионирования. Стратегия версионирования определяется аннотацией `@Version` и может быть `OPTIMISTIC` или `PESSIMISTIC`.

- `OPTIMISTIC` - это стратегия, при которой Hibernate сначала считывает данные из базы данных, а затем сравнивает версии при обновлении. Если версии совпадают, изменения сохраняются, иначе генерируется исключение `OptimisticLockException`.
- `PESSIMISTIC` - это стратегия, при которой Hibernate блокирует запись в базе данных на время обновления. Это означает, что другие пользователи не смогут изменить запись, пока текущий пользователь не закончит обновление.
- `NONE` - это стратегия, при которой Hibernate не использует версионирование. Это означает, что при параллельных изменениях могут возникнуть конфликты и потеря данных.
- `DEFAULT` - это стратегия по умолчанию, которая зависит от поставщика JPA. Например, для Hibernate это `OPTIMISTIC`.

Например, создадим Entity класс `Product`:

```java

@Entity
@Table(name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Version
    private Long version;
    
    private String name;
    
    // Другие поля и методы
}
```

В этом примере поле `version` аннотировано как `@Version`, что указывает JPA на то, что это поле содержит версию сущности. При обновлении сущности Hibernate будет увеличивать значение версии. Стратегия версионирования по умолчанию для Hibernate - `OPTIMISTIC`.

Если мы хотим изменить стратегию версионирования, мы можем использовать аннотацию `@OptimisticLocking`. Например, изменим стратегию версионирования на `PESSIMISTIC`:

```java

@Entity
@Table(name = "products")
@OptimisticLocking(type = OptimisticLockType.ALL)
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Version
    private Long version;
    
    private String name;
    
    // Другие поля и методы
}
```

В этом примере мы использовали аннотацию `@OptimisticLocking` с параметром `OptimisticLockType.ALL`, что означает, что Hibernate будет блокировать запись на время обновления.

SQL запрос, который Hibernate выполнит для создания таблицы, будет выглядеть примерно так:

```sql
CREATE TABLE products (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    version BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL
);
```

Как видим, для базы данных версионирование сущности представлено лишь в виде отдельного служебного поля, которым будет управлять только Hibernate.

# [**Назад**: *Список аннотаций*](entity.md)
